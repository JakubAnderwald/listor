{
  "rules": {
    "users": {
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        "profile": {
          ".validate": "newData.hasChildren(['uid', 'email', 'displayName', 'lastLogin'])",
          "uid": {
            ".validate": "newData.isString() && newData.val() === $uid"
          },
          "email": {
            ".validate": "newData.isString() && newData.val().matches(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/)"
          },
          "displayName": {
            ".validate": "newData.isString()"
          },
          "photoURL": {
            ".validate": "!newData.exists() || newData.isString()"
          },
          "lastLogin": {
            ".validate": "newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}.\\d{3}Z$/)"
          }
        },
        "lists": {
          "$listId": {
            ".validate": "newData.hasChildren(['name', 'color'])",
            "name": {
              ".validate": "newData.isString() && newData.val().length > 0"
            },
            "color": {
              ".validate": "newData.isString() && newData.val().matches(/^#[0-9A-Fa-f]{6}$/)"
            },
            "createdAt": {
              ".validate": "newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}.\\d{3}Z$/)"
            },
            "sharedWith": {
              "$email": {
                ".validate": "newData.isString() && newData.val().matches(/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/)"
              }
            }
          }
        },
        "todos": {
          "$todoId": {
            ".validate": "newData.hasChildren(['text', 'completed', 'listId'])",
            "text": {
              ".validate": "newData.isString() && newData.val().length > 0"
            },
            "completed": {
              ".validate": "newData.isBoolean()"
            },
            "dueDate": {
              ".validate": "!newData.exists() || newData.isString()"
            },
            "recurrenceType": {
              ".validate": "!newData.exists() || (newData.isString() && ['none', 'daily', 'weekly', 'monthly', 'yearly'].includes(newData.val()))"
            },
            "originalDueDate": {
              ".validate": "!newData.exists() || newData.isString()"
            },
            "priority": {
              ".validate": "!newData.exists() || (newData.isString() && ['none', 'low', 'medium', 'high'].includes(newData.val()))"
            },
            "listId": {
              ".validate": "newData.isNumber()"
            }
          }
        },
        "sharedWithMe": {
          "$ownerUid": {
            "$listId": {
              ".read": "auth.token.email === root.child('users').child($ownerUid).child('lists').child($listId).child('sharedWith').child(auth.token.email.replace('.', '_')).val()",
              ".write": "auth.token.email === root.child('users').child($ownerUid).child('lists').child($listId).child('sharedWith').child(auth.token.email.replace('.', '_')).val()"
            }
          }
        }
      }
    }
  }
}